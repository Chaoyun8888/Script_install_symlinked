#!/bin/bash

# settings for chroot
if [ -z "$debian_chroot" -a -r /etc/debian_chroot ]; then
  debian_chroot=$(cat /etc/debian_chroot)
fi

if [[ $COLORTERM = gnome-* && $TERM = xterm ]] && infocmp gnome-256color >/dev/null 2>&1; then
  export TERM=gnome-256color
elif infocmp xterm-256color >/dev/null 2>&1; then
  export TERM=xterm-256color
fi

# set the title (user@host:dir)
PROMPT_COMMAND='color_prompt=yes; echo -ne "\033]0;${USER}@${HOSTNAME}: ${PWD/$HOME/~}\007"'

__git_dirty()
{
  git diff --quiet HEAD &>/dev/null 
  [ $? == 1 ] && echo "!"
}

__git_branch()
{
  __git_ps1 " (%s)"
}

__svn_branch()
{
  __svn_url | sed -e 's#^'"$(__svn_repository_root)"'##g' | awk '{print " ("$1")" }'
}

__svn_url()
{
  svn info 2>/dev/null | sed -ne 's#^URL: ##p'
}

__svn_repository_root()
{
  svn info 2>/dev/null | sed -ne 's#^Repository Root: ##p'
}

__last_command_status()
{
  if [ "$?" -eq "0" ]; then
    echo -e ${COLOR_GREEN}${ICON_FOR_TRUE}
  else
    echo -e ${COLOR_RED}${ICON_FOR_FALSE}
  fi
}

prompt_command()
{
  # Local or SSH session?
  local remote=""
  [ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ] && remote=1

  # set the user-color
  local user_color=$COLOR_LIGHT_GREEN           # user's color
  [ $UID -eq "0" ] && user_color=$COLOR_RED     # root's color

  # set the user
  local user="\u"

  # set the hostname inside SSH session
  local host=""
  [ -n "$remote" ] && host="\[$COLOR_LIGHT_GREEN\]${ICON_FOR_AT}\h"

  # INFO:   Text (commands) inside \[...\] does not impact line length calculation which fixes stange bug when looking through the history
  #         $? is a status of last command, should be processed every time prompt prints

  # Format prompt
  export PS1="\n\$(__last_command_status) \[$user_color\]${user}${host}\[$user_color\]:\[$COLOR_LIGHT_BLUE\]\w\[$COLOR_LIGHT_RED\]${ICON_FOR_ARROW_RIGHT}\$(__git_branch)\$(__svn_branch)\$(__git_dirty)\[$COLOR_NO_COLOUR\] "

  # Multiline command
  export PS2="\[$COLOR_LIGHT_RED\]${ICON_FOR_ARROW_RIGHT}\[$COLOR_NO_COLOUR\]"

  # Terminal title
  echo -ne "\033]0;${USER}@${HOSTNAME}: ${PWD/$HOME/~}\007"
}

# Show awesome prompt only if Git is istalled
command -v git >/dev/null 2>&1 && PROMPT_COMMAND=prompt_command
